
def label = "mypod-${UUID.randomUUID().toString()}"

properties([
    parameters([
        stringParam(
            defaultValue: '***', 
            description: '', 
            name: 'service')
    ])
])

podTemplate(label: label, containers: [
  containerTemplate(name: 'python-alpine', image: 'ghostgoose33/python-alp:v3', command: 'cat', ttyEnabled: true),
  containerTemplate(name: 'helm', image: 'ghostgoose33/kubectl_helm:v1', command: 'cat', ttyEnabled: true)
],
volumes: [
  hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')
], serviceAccount: "jenkins") 
{


node(label)
{
    try{
	
        stage("Deploy to Kubernetes"){
	    build(job: 'GitHub/Kubik-DB/master', parameters: [[$class: 'StringParameterValue', name:"service", value: "***"]], wait: true)
            if(params.service == "db"){
		container ("helm"){
		    sh "helm upgrade --install --namespace production --force db-service chartmuseum/db-service --set=deploy.version=v1,image.tag=${params.imageTagDB_}"
			
	    }
	    }
            if(params.service == "get"){
		container ("helm"){
		    sh "helm upgrade --install --namespace production --force get-service chartmuseum/get-service --set=deploy.version=v1,image.tag=${params.imageTagGET_}}"
			
	    }
	    }
	    if(params.service == "ui"){
		container ("helm"){
		    sh "helm upgrade --install --namespace production --force ui-service chartmuseum/ui-service --set=deploy.version=v1,image.tag=${params.imageTagUI_}}"
			
	    }
	    }
            
            if(params.service == "post"){
		container ("helm"){
		    sh "helm upgrade --install --namespace production --force post-service chartmuseum/post-service --set=deploy.version=v1,image.tag=${params.imageTagPOST_}}"
			
	    }
	    }    
        }

	sleep 10

        stage ("Prod Tests"){
            container('python-alpine'){
	            //sh "python3 /e2e-test-prod.py"
          }
        }
        
    }
    catch(err){
        currentBuild.result = 'Failure'
    }
}
}
